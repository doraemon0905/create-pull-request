name: ğŸ¯ Manual Publish

# This workflow allows manual publishing with more control and options
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.2.3) - leave empty to use current version'
        required: false
        type: string
      tag:
        description: 'NPM dist-tag (latest, beta, alpha, etc.)'
        required: true
        default: 'latest'
        type: choice
        options:
          - latest
          - beta
          - alpha
          - next
          - canary
      dry_run:
        description: 'Dry run (test without actually publishing)'
        required: false
        default: true
        type: boolean
      force_publish:
        description: 'Force publish (skip some validations)'
        required: false
        default: false
        type: boolean

jobs:
  manual-publish:
    runs-on: ubuntu-latest
    environment: production  # Require manual approval for production deploys
    
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ“‹ Display publish configuration
        run: |
          echo "ğŸ¯ Manual Publish Configuration"
          echo "================================"
          echo "Version: ${{ github.event.inputs.version || 'current' }}"
          echo "Tag: ${{ github.event.inputs.tag }}"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          echo "Force: ${{ github.event.inputs.force_publish }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current package version: $CURRENT_VERSION"
          
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "Will publish version: ${{ github.event.inputs.version }}"
          else
            echo "Will publish current version: $CURRENT_VERSION"
          fi
      
      # Set custom version if provided
      - name: ğŸ“ Set custom version
        if: github.event.inputs.version != ''
        run: |
          CUSTOM_VERSION="${{ github.event.inputs.version }}"
          echo "Setting version to: $CUSTOM_VERSION"
          
          # Update package.json without creating git tag
          npm version "$CUSTOM_VERSION" --no-git-tag-version
          
          echo "PUBLISH_VERSION=$CUSTOM_VERSION" >> $GITHUB_ENV
      
      - name: ğŸ“‹ Set current version
        if: github.event.inputs.version == ''
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "PUBLISH_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
      
      # Conditional validation (can be skipped with force)
      - name: ğŸ§ª Run tests
        if: github.event.inputs.force_publish != 'true'
        run: npm test
      
      - name: ğŸ“ Run linting
        if: github.event.inputs.force_publish != 'true'
        run: npm run lint
      
      - name: ğŸ—ï¸ Build project
        run: npm run build
      
      - name: ğŸ”’ Security audit
        if: github.event.inputs.force_publish != 'true'
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: âš ï¸ Force publish warning
        if: github.event.inputs.force_publish == 'true'
        run: |
          echo "âš ï¸  WARNING: Force publish enabled!"
          echo "   - Tests may have been skipped"
          echo "   - Linting may have been skipped"
          echo "   - Security audit may have been skipped"
          echo ""
      
      - name: ğŸ“Š Pre-publish information
        run: |
          echo "ğŸ“¦ Package Information"
          echo "====================="
          
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "Name: $PACKAGE_NAME"
          echo "Version: ${{ env.PUBLISH_VERSION }}"
          echo "Tag: ${{ github.event.inputs.tag }}"
          echo ""
          
          echo "ğŸ“ Package Contents:"
          npm pack --dry-run
          echo ""
          
          # Check if version already exists
          if npm view "$PACKAGE_NAME@${{ env.PUBLISH_VERSION }}" version > /dev/null 2>&1; then
            echo "âš ï¸  Version ${{ env.PUBLISH_VERSION }} already exists on NPM!"
            echo "   This will overwrite the existing version with the same tag."
          else
            echo "âœ… Version ${{ env.PUBLISH_VERSION }} is new"
          fi
      
      # Dry run
      - name: ğŸ§ª NPM Publish (Dry Run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ§ª DRY RUN MODE - No actual publishing"
          echo "======================================"
          
          TAG="${{ github.event.inputs.tag }}"
          if [ "$TAG" != "latest" ]; then
            echo "Would run: npm publish --tag $TAG --dry-run"
            npm publish --tag "$TAG" --dry-run
          else
            echo "Would run: npm publish --dry-run"
            npm publish --dry-run
          fi
          
          echo ""
          echo "âœ… Dry run completed successfully"
          echo "   Remove 'dry_run' option to actually publish"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      # Actual publish
      - name: ğŸš€ NPM Publish (LIVE)
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "ğŸš€ LIVE PUBLISH MODE"
          echo "==================="
          echo "âš ï¸ Note: Ensure NPM_TOKEN is an Automation token to bypass 2FA"
          
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          TAG="${{ github.event.inputs.tag }}"
          
          if [ "$TAG" != "latest" ]; then
            echo "Publishing with tag: $TAG"
            npm publish --tag "$TAG"
            echo "ğŸ“¦ Published: $PACKAGE_NAME@${{ env.PUBLISH_VERSION }} with tag '$TAG'"
            echo "ğŸ”— Install: npm install $PACKAGE_NAME@$TAG"
          else
            echo "Publishing to latest"
            npm publish
            echo "ğŸ“¦ Published: $PACKAGE_NAME@${{ env.PUBLISH_VERSION }}"
            echo "ğŸ”— Install: npm install -g $PACKAGE_NAME"
          fi
          
          echo ""
          echo "ğŸŒ View on NPM: https://www.npmjs.com/package/$PACKAGE_NAME"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: ğŸ·ï¸ Create Git Tag (for custom versions)
        if: github.event.inputs.version != '' && github.event.inputs.dry_run == 'false'
        run: |
          TAG_NAME="v${{ env.PUBLISH_VERSION }}"
          
          # Create and push tag
          git tag "$TAG_NAME" -m "Release $TAG_NAME (manual publish)"
          git push origin "$TAG_NAME"
          
          echo "âœ… Created and pushed git tag: $TAG_NAME"
      
      - name: ğŸ“Š Post-publish validation
        if: github.event.inputs.dry_run == 'false'
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          TAG="${{ github.event.inputs.tag }}"
          
          echo "â³ Waiting for NPM registry to sync..."
          sleep 30
          
          if [ "$TAG" != "latest" ]; then
            INSTALL_CMD="npm install $PACKAGE_NAME@$TAG"
          else
            INSTALL_CMD="npm install -g $PACKAGE_NAME"
          fi
          
          echo "ğŸ” Verifying publication..."
          if npm view "$PACKAGE_NAME@${{ env.PUBLISH_VERSION }}" version > /dev/null 2>&1; then
            echo "âœ… Package verified on NPM registry"
            echo "ğŸ“¦ Install command: $INSTALL_CMD"
          else
            echo "âš ï¸ Package may still be syncing..."
          fi
      
      - name: ğŸ“‹ Success Summary
        if: success()
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          TAG="${{ github.event.inputs.tag }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          echo ""
          echo "ğŸ‰ Manual Publish Completed!"
          echo "============================"
          echo "ğŸ“¦ Package: $PACKAGE_NAME"
          echo "ğŸ”¢ Version: ${{ env.PUBLISH_VERSION }}"
          echo "ğŸ·ï¸  Tag: $TAG"
          echo "ğŸ§ª Dry Run: $DRY_RUN"
          echo "ğŸ‘¤ Published by: ${{ github.actor }}"
          echo ""
          
          if [ "$DRY_RUN" == "false" ]; then
            echo "âœ… Successfully published to NPM!"
            echo "ğŸ”— https://www.npmjs.com/package/$PACKAGE_NAME"
            
            if [ "$TAG" != "latest" ]; then
              echo "ğŸ“¥ Install: npm install $PACKAGE_NAME@$TAG"
            else
              echo "ğŸ“¥ Install: npm install -g $PACKAGE_NAME"
            fi
          else
            echo "ğŸ§ª Dry run completed - no actual publish performed"
          fi
