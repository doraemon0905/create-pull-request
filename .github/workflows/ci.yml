name: üîç CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security audits on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  # Validate code quality on all pushes and PRs
  validate:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20, 22]  # Test multiple Node.js versions
    
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: üì¶ Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            lib
            *.tsbuildinfo
          key: build-${{ runner.os }}-node${{ matrix.node-version }}-${{ hashFiles('src/**/*', 'tsconfig.json') }}
          restore-keys: |
            build-${{ runner.os }}-node${{ matrix.node-version }}-
            build-${{ runner.os }}-
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üîç Check package integrity
        run: |
          # Verify package-lock.json is in sync
          npm ci --dry-run
          
          # Check for security issues in dependencies
          npm audit --audit-level=moderate
        continue-on-error: ${{ matrix.node-version != 20 }}  # Only fail on primary version
      
      - name: üìù Run ESLint
        run: npm run lint
      
      - name: üèóÔ∏è Build TypeScript
        run: npm run build
      
      - name: üß™ Run tests with coverage
        run: npm test -- --coverage --watchAll=false
      
      - name: üìä Upload coverage artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.node-version }}
          path: coverage/
          retention-days: 30
      
      - name: üìä Check build artifacts
        run: |
          echo "üîç Checking build artifacts..."
          
          # Verify main entry point exists
          if [ ! -f "lib/index.js" ]; then
            echo "‚ùå Main entry point missing!"
            exit 1
          fi
          
          # Verify CLI binary exists and is executable
          if [ ! -f "bin/create-pr" ]; then
            echo "‚ùå CLI binary missing!"
            exit 1
          fi
          
          if [ ! -x "bin/create-pr" ]; then
            echo "‚ùå CLI binary not executable!"
            exit 1
          fi
          
          # Check TypeScript declarations
          if [ ! -f "lib/index.d.ts" ]; then
            echo "‚ùå TypeScript declarations missing!"
            exit 1
          fi
          
          echo "‚úÖ All build artifacts present and valid"
      
      - name: üîç Package validation
        run: |
          echo "üîç Validating package.json..."
          
          # Check required fields
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'main', 'bin', 'license'];
            const missing = required.filter(field => !pkg[field]);
            if (missing.length > 0) {
              console.error('‚ùå Missing required fields:', missing.join(', '));
              process.exit(1);
            }
            console.log('‚úÖ All required package.json fields present');
          "
          
          # Validate semantic versioning
          node -e "
            const pkg = require('./package.json');
            const semverRegex = /^\\d+\\.\\d+\\.\\d+/;
            if (!semverRegex.test(pkg.version)) {
              console.error('‚ùå Invalid version format:', pkg.version);
              process.exit(1);
            }
            console.log('‚úÖ Version format valid:', pkg.version);
          "
      
      - name: üß™ Test CLI functionality (smoke test)
        run: |
          echo "üß™ Testing CLI functionality..."
          
          # Make binary executable (in case git doesn't preserve it)
          chmod +x bin/create-pr
          
          # Test help command
          node bin/create-pr --help > /dev/null
          if [ $? -eq 0 ]; then
            echo "‚úÖ CLI help command works"
          else
            echo "‚ùå CLI help command failed"
            exit 1
          fi
          
          # Test config command
          node bin/create-pr config > /dev/null
          if [ $? -eq 0 ]; then
            echo "‚úÖ CLI config command works"
          else
            echo "‚ùå CLI config command failed"
            exit 1
          fi
      
      - name: üì¶ Test packaging
        if: matrix.node-version == 20  # Only test on primary version
        run: |
          echo "üì¶ Testing npm pack..."
          
          # Create pack output in temp location
          PACK_OUTPUT=$(mktemp)
          npm pack --dry-run > "$PACK_OUTPUT" 2>&1
          
          echo "üìã Package contents:"
          cat "$PACK_OUTPUT"
          echo ""
          
          # Check if essential files are included
          if ! grep -q "lib/" "$PACK_OUTPUT"; then
            echo "‚ùå Build artifacts not included in package"
            cat "$PACK_OUTPUT"
            exit 1
          fi
          
          if ! grep -q "bin/" "$PACK_OUTPUT"; then
            echo "‚ùå CLI binary not included in package"
            cat "$PACK_OUTPUT"
            exit 1
          fi
          
          if ! grep -q "README.md" "$PACK_OUTPUT"; then
            echo "‚ùå README not included in package"
            cat "$PACK_OUTPUT"
            exit 1
          fi
          
          echo "‚úÖ Package contents validated"
          
          # Check package size
          TARBALL=$(npm pack --silent)
          PACKAGE_SIZE=$(ls -la "$TARBALL" | awk '{print $5}')
          echo "üì¶ Package size: $PACKAGE_SIZE bytes"
          
          # Clean up tarball
          rm -f "$TARBALL"
          rm -f "$PACK_OUTPUT"
          
          # Warn if package is too large (>5MB)
          if [ "$PACKAGE_SIZE" -gt 5242880 ]; then
            echo "‚ö†Ô∏è Package size is quite large (>5MB)"
          fi

  # Security and dependency checks
  security:
    runs-on: ubuntu-latest
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Cache security tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            /tmp/license-checker-*
            audit-report.json
          key: security-tools-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            security-tools-${{ runner.os }}-
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üîí Security audit
        run: |
          echo "üîí Running security audit..."
          npm audit --audit-level=moderate
          
          # Generate audit report
          npm audit --json > audit-report.json || true
          
          # Check for high/critical issues
          HIGH_ISSUES=$(cat audit-report.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_ISSUES=$(cat audit-report.json | jq '.metadata.vulnerabilities.critical // 0')
          
          echo "Security summary:"
          echo "  High issues: $HIGH_ISSUES"
          echo "  Critical issues: $CRITICAL_ISSUES"
          
          if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo "‚ùå Critical security issues found!"
            exit 1
          elif [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "‚ö†Ô∏è High security issues found - review recommended"
          else
            echo "‚úÖ No high or critical security issues"
          fi
      
      - name: üîç License check
        run: |
          echo "üîç Checking dependency licenses..."
          # This requires license-checker to be installed
          npx license-checker --summary || echo "License check skipped - license-checker not available"

  # Code quality analysis
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Cache analysis results
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            .eslintcache
            coverage
          key: code-quality-${{ runner.os }}-${{ hashFiles('src/**/*', '.eslintrc.*', 'tsconfig.json') }}
          restore-keys: |
            code-quality-${{ runner.os }}-
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üìä Code complexity analysis
        run: |
          echo "üìä Analyzing code complexity..."
          
          # Simple complexity check using find and wc
          TOTAL_LINES=$(find src -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print $1}')
          FILE_COUNT=$(find src -name "*.ts" | wc -l)
          
          if [ "$FILE_COUNT" -gt 0 ]; then
            AVG_LINES=$((TOTAL_LINES / FILE_COUNT))
            echo "üìà Code statistics:"
            echo "   Total files: $FILE_COUNT"
            echo "   Total lines: $TOTAL_LINES"
            echo "   Average lines per file: $AVG_LINES"
            
            if [ "$AVG_LINES" -gt 300 ]; then
              echo "‚ö†Ô∏è Average file size is quite large - consider refactoring"
            else
              echo "‚úÖ File sizes look reasonable"
            fi
          fi
      
      - name: üîç Dead code detection
        run: |
          echo "üîç Checking for potential dead code..."
          
          # Check for TODO/FIXME comments
          TODO_COUNT=$(find src -name "*.ts" -exec grep -l "TODO\|FIXME\|XXX" {} + | wc -l)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "üìù Found $TODO_COUNT files with TODO/FIXME comments"
            find src -name "*.ts" -exec grep -Hn "TODO\|FIXME\|XXX" {} +
          else
            echo "‚úÖ No TODO/FIXME comments found"
          fi

  # Compatibility testing
  compatibility:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [20]
    
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: üì¶ Cache compatibility build
        uses: actions/cache@v4
        with:
          path: |
            lib
            *.tsbuildinfo
            ~/.npm
          key: compat-build-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('src/**/*', 'tsconfig.json', 'package-lock.json') }}
          restore-keys: |
            compat-build-${{ runner.os }}-${{ matrix.node-version }}-
            compat-build-${{ runner.os }}-
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üèóÔ∏è Build project
        run: npm run build
      
      - name: üß™ Test CLI on ${{ matrix.os }}
        shell: bash
        run: |
          echo "üß™ Testing CLI functionality on ${{ matrix.os }}..."
          
          # Test help command
          node bin/create-pr --help
          
          # Test config command
          node bin/create-pr config
          
          echo "‚úÖ CLI works on ${{ matrix.os }}"

  # Report results
  report:
    runs-on: ubuntu-latest
    needs: [validate, security, code-quality, compatibility]
    if: always()
    
    steps:
      - name: üìä CI Summary
        run: |
          echo "üìä CI/CD Pipeline Summary"
          echo "========================"
          echo "Validation: ${{ needs.validate.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Compatibility: ${{ needs.compatibility.result }}"
          echo ""
          
          if [[ "${{ needs.validate.result }}" == "success" && 
                "${{ needs.security.result }}" == "success" && 
                "${{ needs.code-quality.result }}" == "success" && 
                "${{ needs.compatibility.result }}" == "success" ]]; then
            echo "‚úÖ All checks passed! Ready for release."
          else
            echo "‚ùå Some checks failed. Review the results above."
          fi

  # Trigger SonarCloud analysis when all CI jobs pass
  trigger-sonarcloud:
    runs-on: ubuntu-latest
    needs: [validate, security, code-quality, compatibility, report]
    if: |
      needs.validate.result == 'success' && 
      needs.security.result == 'success' && 
      needs.code-quality.result == 'success' && 
      needs.compatibility.result == 'success' &&
      needs.report.result == 'success'
    
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: üöÄ Trigger SonarCloud Analysis
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const ref = context.ref;
            
            console.log(`üöÄ Triggering SonarCloud analysis for ${owner}/${repo}@${ref}`);
            console.log(`üìä All CI jobs completed successfully, including report job`);
            console.log(`üîë Using token with permissions: actions:write, contents:read`);
            
            try {
              // First, let's check if the workflow exists
              console.log('üîç Checking if SonarCloud workflow exists...');
              const workflows = await github.rest.actions.listWorkflowsForRepo({
                owner,
                repo
              });
              
              const sonarWorkflow = workflows.data.workflows.find(w => w.name === 'SonarCloud Analysis');
              if (!sonarWorkflow) {
                console.log('‚ùå SonarCloud Analysis workflow not found');
                console.log('üìã Available workflows:', workflows.data.workflows.map(w => w.name));
                return;
              }
              
              console.log(`‚úÖ Found SonarCloud workflow: ${sonarWorkflow.name} (ID: ${sonarWorkflow.id})`);
              
              // Try to trigger the SonarCloud workflow using workflow_dispatch
              const response = await github.rest.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: sonarWorkflow.id,
                ref: ref,
                inputs: {
                  triggered_by: 'ci-pipeline',
                  ci_run_id: context.runId
                }
              });
              
              console.log('‚úÖ SonarCloud workflow triggered successfully');
              console.log(`üìã Response status: ${response.status}`);
            } catch (error) {
              console.error('‚ùå Failed to trigger SonarCloud workflow:', error.message);
              console.error('üîç Error details:', {
                status: error.status,
                response: error.response?.data,
                url: error.request?.url
              });
              
              // Try alternative approach: create a repository dispatch event
              console.log('üîÑ Trying alternative approach with repository dispatch...');
              try {
                await github.rest.repos.createDispatchEvent({
                  owner,
                  repo,
                  event_type: 'sonarcloud-trigger',
                  client_payload: {
                    triggered_by: 'ci-pipeline',
                    ci_run_id: context.runId,
                    ref: ref
                  }
                });
                console.log('‚úÖ Repository dispatch event created successfully');
              } catch (dispatchError) {
                console.error('‚ùå Repository dispatch also failed:', dispatchError.message);
                console.log('‚ö†Ô∏è Continuing without SonarCloud analysis...');
              }
            }
