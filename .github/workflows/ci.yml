name: üîç CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security audits on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

# Cancel previous runs when a new commit is pushed to the same branch or PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Security checks - runs first (required)
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Check if run was cancelled
        run: |
          echo "üîç Security Job - CI Run Information:"
          echo "Workflow: ${{ github.workflow }}"
          echo "Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "‚úÖ Security job proceeding (previous runs cancelled if any)"
      
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üîí Run security audit
        run: npm audit --audit-level=moderate
      
      - name: üîç Check for known vulnerabilities
        run: |
          echo "üîç Checking for security vulnerabilities..."
          npm audit --audit-level=high --json > audit-results.json || true
          
          # Check if there are high or critical vulnerabilities
          if [ -f "audit-results.json" ]; then
            HIGH_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
            CRITICAL_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
            
            echo "üìä Security Audit Results:"
            echo "  High vulnerabilities: $HIGH_VULNS"
            echo "  Critical vulnerabilities: $CRITICAL_VULNS"
            
            if [ "$CRITICAL_VULNS" -gt 0 ]; then
              echo "‚ùå Critical vulnerabilities found! Please fix them before proceeding."
              exit 1
            elif [ "$HIGH_VULNS" -gt 0 ]; then
              echo "‚ö†Ô∏è High vulnerabilities found. Consider fixing them."
            else
              echo "‚úÖ No critical or high vulnerabilities found."
            fi
          fi

  # Code quality analysis - runs after security (required)
  code-quality:
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Cache analysis results
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            .eslintcache
            coverage
          key: code-quality-${{ runner.os }}-${{ hashFiles('src/**/*', '.eslintrc.*', 'tsconfig.json') }}
          restore-keys: |
            code-quality-${{ runner.os }}-
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üìä Code complexity analysis
        run: |
          echo "üìä Analyzing code complexity..."
          
          # Simple complexity check using find and wc
          TOTAL_LINES=$(find src -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print $1}')
          FILE_COUNT=$(find src -name "*.ts" | wc -l)
          
          if [ "$FILE_COUNT" -gt 0 ]; then
            AVG_LINES=$((TOTAL_LINES / FILE_COUNT))
            echo "üìà Code statistics:"
            echo "   Total files: $FILE_COUNT"
            echo "   Total lines: $TOTAL_LINES"
            echo "   Average lines per file: $AVG_LINES"
            
            if [ "$AVG_LINES" -gt 300 ]; then
              echo "‚ö†Ô∏è Average file size is quite large - consider refactoring"
            else
              echo "‚úÖ File sizes look reasonable"
            fi
          fi
      
      - name: üîç Dead code detection
        run: |
          echo "üîç Checking for potential dead code..."
          
          # Check for TODO/FIXME comments
          TODO_COUNT=$(find src -name "*.ts" -exec grep -l "TODO\|FIXME\|XXX" {} + | wc -l)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "üìù Found $TODO_COUNT files with TODO/FIXME comments"
            find src -name "*.ts" -exec grep -Hn "TODO\|FIXME\|XXX" {} +
          else
            echo "‚úÖ No TODO/FIXME comments found"
          fi

  # Validate code quality on all pushes and PRs - runs after security and code-quality
  validate:
    runs-on: ubuntu-latest
    needs: [security, code-quality]
    
    strategy:
      matrix:
        node-version: [18, 20, 22]  # Test multiple Node.js versions
    
    steps:
      - name: Check if run was cancelled
        run: |
          echo "üîç CI Run Information:"
          echo "Workflow: ${{ github.workflow }}"
          echo "Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "‚úÖ This run is proceeding (previous runs cancelled if any)"
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: üì¶ Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            lib
            *.tsbuildinfo
          key: build-${{ runner.os }}-node${{ matrix.node-version }}-${{ hashFiles('src/**/*', 'tsconfig.json') }}
          restore-keys: |
            build-${{ runner.os }}-node${{ matrix.node-version }}-
            build-${{ runner.os }}-
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üîç Check package integrity
        run: |
          # Verify package-lock.json is in sync
          npm ci --dry-run
          
          # Check for security issues in dependencies
          npm audit --audit-level=moderate
        continue-on-error: ${{ matrix.node-version != 20 }}  # Only fail on primary version
      
      - name: üìù Run ESLint
        run: npm run lint
      
      - name: üèóÔ∏è Build TypeScript
        run: npm run build
      
      - name: üß™ Run tests with coverage
        run: npm test -- --coverage --watchAll=false
      
      - name: üìä Upload coverage artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.node-version }}
          path: coverage/
          retention-days: 30
      
      - name: üìä Check build artifacts
        run: |
          echo "üîç Checking build artifacts..."
          
          # Verify main entry point exists
          if [ ! -f "lib/index.js" ]; then
            echo "‚ùå Main entry point missing!"
            exit 1
          fi
          
          # Verify CLI binary exists and is executable
          if [ ! -f "bin/create-pr.js" ]; then
            echo "‚ùå CLI binary missing!"
            exit 1
          fi
          
          if [ ! -x "bin/create-pr.js" ]; then
            echo "‚ùå CLI binary not executable!"
            exit 1
          fi
          
          # Check TypeScript declarations
          if [ ! -f "lib/index.d.ts" ]; then
            echo "‚ùå TypeScript declarations missing!"
            exit 1
          fi
          
          echo "‚úÖ All build artifacts present and valid"
      
      - name: üîç Package validation
        run: |
          echo "üîç Validating package.json..."
          
          # Check required fields
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'main', 'bin', 'license'];
            const missing = required.filter(field => !pkg[field]);
            if (missing.length > 0) {
              console.error('‚ùå Missing required fields:', missing.join(', '));
              process.exit(1);
            }
            console.log('‚úÖ All required package.json fields present');
          "
          
          # Validate semantic versioning
          node -e "
            const pkg = require('./package.json');
            const semverRegex = /^\\d+\\.\\d+\\.\\d+/;
            if (!semverRegex.test(pkg.version)) {
              console.error('‚ùå Invalid version format:', pkg.version);
              process.exit(1);
            }
            console.log('‚úÖ Version format valid:', pkg.version);
          "
      
      - name: üß™ Test CLI functionality (smoke test)
        run: |
          echo "üß™ Testing CLI functionality..."
          
          # Make binary executable (in case git doesn't preserve it)
          chmod +x bin/create-pr.js
          
          # Test help command
          node bin/create-pr.js --help > /dev/null
          if [ $? -eq 0 ]; then
            echo "‚úÖ CLI help command works"
          else
            echo "‚ùå CLI help command failed"
            exit 1
          fi
          
          # Test config command
          node bin/create-pr.js config > /dev/null
          if [ $? -eq 0 ]; then
            echo "‚úÖ CLI config command works"
          else
            echo "‚ùå CLI config command failed"
            exit 1
          fi
      
      - name: üì¶ Test packaging
        if: matrix.node-version == 20  # Only test on primary version
        run: |
          echo "üì¶ Testing npm pack..."
          
          # Create pack output in temp location
          PACK_OUTPUT=$(mktemp)
          npm pack --dry-run > "$PACK_OUTPUT" 2>&1
          
          echo "üìã Package contents:"
          cat "$PACK_OUTPUT"
          echo ""
          
          # Check if essential files are included
          if ! grep -q "lib/" "$PACK_OUTPUT"; then
            echo "‚ùå Build artifacts not included in package"
            cat "$PACK_OUTPUT"
            exit 1
          fi
          
          if ! grep -q "bin/" "$PACK_OUTPUT"; then
            echo "‚ùå CLI binary not included in package"
            cat "$PACK_OUTPUT"
            exit 1
          fi
          
          if ! grep -q "README.md" "$PACK_OUTPUT"; then
            echo "‚ùå README not included in package"
            cat "$PACK_OUTPUT"
            exit 1
          fi
          
          echo "‚úÖ Package contents validated"
          
          # Check package size
          TARBALL=$(npm pack --silent)
          PACKAGE_SIZE=$(ls -la "$TARBALL" | awk '{print $5}')
          echo "üì¶ Package size: $PACKAGE_SIZE bytes"
          
          # Clean up tarball
          rm -f "$TARBALL"
          rm -f "$PACK_OUTPUT"
          
          # Warn if package is too large (>5MB)
          if [ "$PACKAGE_SIZE" -gt 5242880 ]; then
            echo "‚ö†Ô∏è Package size is quite large (>5MB)"
          fi

  # Compatibility testing - runs only when all validation jobs pass
  compatibility:
    runs-on: ubuntu-latest
    needs: [security, code-quality, validate]
    if: |
      needs.security.result == 'success' && 
      needs.code-quality.result == 'success' && 
      needs.validate.result == 'success'
    steps:
      - name: Check if run was cancelled
        run: |
          echo "üîç Compatibility Job - CI Run Information:"
          echo "Workflow: ${{ github.workflow }}"
          echo "Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "‚úÖ Compatibility job proceeding - all validation jobs passed successfully"
          echo "üìã Dependencies: security ‚úÖ, code-quality ‚úÖ, validate ‚úÖ"
      
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Cache security tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            /tmp/license-checker-*
            audit-report.json
          key: security-tools-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            security-tools-${{ runner.os }}-
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üîí Security audit
        run: |
          echo "üîí Running security audit..."
          npm audit --audit-level=moderate
          
          # Generate audit report
          npm audit --json > audit-report.json || true
          
          # Check for high/critical issues
          HIGH_ISSUES=$(cat audit-report.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_ISSUES=$(cat audit-report.json | jq '.metadata.vulnerabilities.critical // 0')
          
          echo "Security summary:"
          echo "  High issues: $HIGH_ISSUES"
          echo "  Critical issues: $CRITICAL_ISSUES"
          
          if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo "‚ùå Critical security issues found!"
            exit 1
          elif [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "‚ö†Ô∏è High security issues found - review recommended"
          else
            echo "‚úÖ No high or critical security issues"
          fi
      
      - name: üîç License check
        run: |
          echo "üîç Checking dependency licenses..."
          # This requires license-checker to be installed
          npx license-checker --summary || echo "License check skipped - license-checker not available"

  # Report results
  report:
    runs-on: ubuntu-latest
    needs: [validate, security, code-quality, compatibility]
    if: always()
    
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üì¶ Cache analysis results
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            .eslintcache
            coverage
          key: code-quality-${{ runner.os }}-${{ hashFiles('src/**/*', '.eslintrc.*', 'tsconfig.json') }}
          restore-keys: |
            code-quality-${{ runner.os }}-
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üìä Code complexity analysis
        run: |
          echo "üìä Analyzing code complexity..."
          
          # Simple complexity check using find and wc
          TOTAL_LINES=$(find src -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print $1}')
          FILE_COUNT=$(find src -name "*.ts" | wc -l)
          
          if [ "$FILE_COUNT" -gt 0 ]; then
            AVG_LINES=$((TOTAL_LINES / FILE_COUNT))
            echo "üìà Code statistics:"
            echo "   Total files: $FILE_COUNT"
            echo "   Total lines: $TOTAL_LINES"
            echo "   Average lines per file: $AVG_LINES"
            
            if [ "$AVG_LINES" -gt 300 ]; then
              echo "‚ö†Ô∏è Average file size is quite large - consider refactoring"
            else
              echo "‚úÖ File sizes look reasonable"
            fi
          fi
      
      - name: üîç Dead code detection
        run: |
          echo "üîç Checking for potential dead code..."
          
          # Check for TODO/FIXME comments
          TODO_COUNT=$(find src -name "*.ts" -exec grep -l "TODO\|FIXME\|XXX" {} + | wc -l)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "üìù Found $TODO_COUNT files with TODO/FIXME comments"
            find src -name "*.ts" -exec grep -Hn "TODO\|FIXME\|XXX" {} +
          else
            echo "‚úÖ No TODO/FIXME comments found"
          fi

  # Trigger SonarCloud analysis when all CI jobs pass
  trigger-sonarcloud:
    runs-on: ubuntu-latest
    needs: [validate, security, code-quality, compatibility, report]
    if: |
      needs.validate.result == 'success' && 
      needs.security.result == 'success' && 
      needs.code-quality.result == 'success' && 
      needs.compatibility.result == 'success' &&
      needs.report.result == 'success'
    
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: üöÄ Trigger SonarCloud Analysis
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const ref = context.ref;
            
            // Determine the source branch and PR number for SonarCloud
            let sourceBranch;
            let prNumber = '';
            
            if (ref.startsWith('refs/pull/')) {
              // For pull requests, we need to get the source branch from the PR
              // Since we're in a PR context, we can use the head ref
              sourceBranch = context.payload.pull_request.head.ref;
              prNumber = context.payload.pull_request.number.toString();
              console.log(`üîç Pull request detected, using source branch: ${sourceBranch}`);
              console.log(`üîç PR Number: ${prNumber}`);
            } else if (context.eventName === 'pull_request') {
              // Alternative PR detection
              sourceBranch = context.payload.pull_request.head.ref;
              prNumber = context.payload.pull_request.number.toString();
              console.log(`üîç Pull request event detected, using source branch: ${sourceBranch}`);
              console.log(`üîç PR Number: ${prNumber}`);
            } else {
              // For direct branch pushes, use the branch name
              sourceBranch = ref.replace('refs/heads/', '');
              console.log(`üîç Branch push detected, using branch: ${sourceBranch}`);
              console.log(`üîç No PR number available for branch push`);
            }
            
            console.log(`üöÄ Triggering SonarCloud analysis for ${owner}/${repo}@${sourceBranch}`);
            console.log(`üìä All CI jobs completed successfully, including report job`);
            console.log(`üîç Original ref: ${ref}, Source branch: ${sourceBranch}`);
            
             // Method 3: Direct API call using fetch (similar to curl command)
                console.log('üîç Attempting direct API call to workflow file...');
                console.log('üîë Using GH_TOKEN from secrets');
                const apiResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/sonarcloud.yml/dispatches`, {
                  method: 'POST',
                  headers: {
                    'Accept': 'application/vnd.github+json',
                    'Authorization': `Bearer ${{ secrets.GH_TOKEN }}`,
                    'X-GitHub-Api-Version': '2022-11-28'
                  },
                  body: JSON.stringify({
                    ref: sourceBranch,
                    inputs: {
                      triggered_by: 'ci-pipeline',
                      pr_number: prNumber,
                      ci_run_id: context.runId.toString()
                    }
                  })
                });
                
                if (apiResponse.ok) {
                  console.log('‚úÖ Direct API call successful');
                  console.log(`üìã Response status: ${apiResponse.status}`);
                } else {
                  const errorText = await apiResponse.text();
                  console.log(`‚ùå Direct API call failed: ${apiResponse.status} - ${errorText}`);
                  throw new Error(`All trigger methods failed. Last error: ${apiResponse.status}`);
                }
